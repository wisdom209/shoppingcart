let express,request,response,User,jwt,check,validationResult,isAuth,jwtCheck,bcrypt;_50d‍.x([["default",()=>_50d‍.o]]);_50d‍.w("express",[["default",["express"],function(v){express=v}],["request",["request"],function(v){request=v}],["response",["response"],function(v){response=v}]]);_50d‍.w("../models/userModel",[["default",["User"],function(v){User=v}]]);_50d‍.w("jsonwebtoken",[["default",["jwt"],function(v){jwt=v}]]);_50d‍.w("express-validator",[["check",["check"],function(v){check=v}],["validationResult",["validationResult"],function(v){validationResult=v}]]);_50d‍.w("../utils",[["isAuth",["isAuth"],function(v){isAuth=v}]]);_50d‍.w("../jwtCheck",[["default",["jwtCheck"],function(v){jwtCheck=v}]]);_50d‍.w("bcryptjs",[["default",["bcrypt"],function(v){bcrypt=v}]]);







const userRouter = express.Router();

userRouter.post(
    "/signin",
    [
        check("email", "Please enter a valid email").isEmail(),
        check("password", "Please enter a valid password").isLength({ min: 6 })
    ],
    (request, response) => {
        const errors = validationResult(request);

        if (!errors.isEmpty()) {
            response.send({
                validationError : errors.array({ onlyFirstError: true })
            });

            return;
        }

        User.findOne({
            email    : request.body.email,
            password : request.body.password
        })
            .then((data) => {
                jwt.sign(
                    { id: data.id, isAdmin: data.isAdmin, name: data.name },
                    "secretKey",
                    { expiresIn: 86000 },
                    (err, token) => {
                        if (err) throw err;
                        response.send({ token, name: data.name });
                    }
                );
            })
            .catch((err) => response.send({ msg: "Invalid email or password" }));
    }
);

userRouter.post(
    "/register",
    [
        check("email", "Please enter a valid email").isEmail(),
        check("password", "Password must be greater than 6 characters").isLength({ min: 6 })
    ],
    (request, response) => {
        const errors = validationResult(request);

        if (!errors.isEmpty()) {
            return response.status(400).json({
                validationError : errors.array({ onlyFirstError: true })
            });
        }

        const user = new User({
            name     : request.body.name,
            email    : request.body.email,
            password : request.body.password
        });


        user
            .save()
            .then((data) => {
                jwt.sign({ id: data.id, name: data.name }, "secretKey", { expiresIn: 86000 }, (err, token) => {
                    if (err) throw err;
                    response.send({ token, name: data.name });
                });
            })
            .catch((err) => response.send({ msg: "Email already exists" }));
    }
);

userRouter.get("/createadmin", (request, response) => {
    const user = new User({
        name     : "wisdom",
        email    : "freezwiz@hi2.in",
        password : "password",
        isAdmin  : true
    });

    user
        .save()
        .then((data) => response.send("Admin " + data.name + " created"))
        .catch((err) => response.send({ msg: err }));
});

_50d‍.d(userRouter);
